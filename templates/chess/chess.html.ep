<%# /templates/chess/chess.html.ep %>

% layout 'default';
% title 'Chess - Game ' . $game->{id};

<% content_for head => begin %>
    <link rel="stylesheet" href="/css/chess/chess.css">
    <%# Using chess.js for complex move validation (castling, en passant, checkmate) on the frontend %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="/js/chess/chess.js" defer></script>
<% end %>

<div class="chess-container">
    <div class="header-bar">
        <h1>â™Ÿï¸ Chess - Game #<%= $game->{id} %></h1>
    </div>

    <div class="game-wrapper">
        <% 
            my $uid = current_user_id();
        %>
        <div class="board-container">
            <div id="chess-board" 
                 data-game-id="<%= $game->{id} %>" 
                 data-fen="<%= $game->{fen_state} %>"
                 data-turn="<%= $game->{current_turn} %>"
                 data-p1="<%= $game->{player1_id} %>"
                 data-p2="<%= $game->{player2_id} %>"
                 data-status="<%= $game->{status} %>"
                 data-user-id="<%= $uid %>">
                 </div>
            
            <div id="draw-offer-overlay" class="game-overlay" style="display: none;">
                <div class="overlay-content">
                    <p>Opponent has offered a draw.</p>
                    <div class="overlay-buttons">
                        <button id="acceptDrawBtn" class="btn-control success">Accept</button>
                        <button id="refuseDrawBtn" class="btn-control danger">Refuse</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-modal" class="game-overlay" style="display: none;">
        <div class="overlay-content">
            <p id="modal-message"></p>
            <div class="overlay-buttons">
                <button id="modal-confirm-btn" class="btn-control success">Confirm</button>
                <button id="modal-cancel-btn" class="btn-control danger">Cancel</button>
                <button id="modal-ok-btn" class="btn-control secondary" style="display: none;">OK</button>
            </div>
        </div>
    </div>

    <div id="promotion-modal" class="game-overlay" style="display: none;">
        <div class="overlay-content">
            <p>Promote your pawn:</p>
            <div class="promotion-choices">
                <button class="promo-btn" data-piece="q">â™›</button>
                <button class="promo-btn" data-piece="r">â™œ</button>
                <button class="promo-btn" data-piece="b">â™</button>
                <button class="promo-btn" data-piece="n">â™</button>
            </div>
        </div>
    </div>

    <div class="status-panel">
        <h3 id="game-status-text">
            <% if ($game->{status} eq 'waiting') { %>
                â³ Waiting for an opponent to join...
            <% } elsif ($game->{status} eq 'finished') { %>
                ğŸ† Game Over!
            <% } else { %>
                <% if ($game->{current_turn} == current_user_id()) { %>
                    ğŸŸ¢ Your Turn
                <% } else { %>
                    ğŸ”´ Opponent's Turn
                <% } %>
            <% } %>
        </h3>

        <div class="game-controls">
            <button id="offerDrawBtn" class="btn-control secondary" style="<%= ($game->{status} eq 'active' && !defined $game->{draw_offered_by}) ? '' : 'display: none;' %>">Offer Draw</button>
            <button id="resignBtn" class="btn-control danger" style="<%= $game->{status} eq 'active' ? '' : 'display: none;' %>">Resign</button>
            <a href="/chess/lobby" class="btn-control lobby">
                <span class="icon">ğŸšª</span> Exit to Lobby
            </a>
        </div>

        <p id="fen-display" class="debug-text" style="font-size: 0.8em; color: #777; margin-top: 10px;">
            Current FEN: <%= $game->{fen_state} %>
        </p>
    </div>
</div>